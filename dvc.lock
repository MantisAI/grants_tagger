schema: '2.0'
stages:
  preprocess_wellcome_science:
    cmd: grants_tagger preprocess wellcome-science data/raw/science_tags_full_version.xlsx
      data/processed/science_grants_tagged_title_synopsis.jsonl
    deps:
    - path: data/raw/science_tags_full_version.xlsx
      md5: 74da2bf7a507e52b8b677ddce19156a9
      size: 2638299
    - path: grants_tagger/preprocess.py
      md5: 959ffb629c7f2c7010052c92c2b18116
      size: 3559
    params:
      params.yaml:
        preprocess_wellcome_science.meta_cols: Grant_ID,Title
        preprocess_wellcome_science.text_cols: Title,Synopsis
    outs:
    - path: data/processed/science_grants_tagged_title_synopsis.jsonl
      md5: 2fb37d57daeece50a0190e16e229647a
      size: 2809039
  train:
    cmd: grants_tagger train data/processed/science_grants_tagged_title_synopsis.jsonl
      models/label_binarizer.pkl models/tfidf-svm-2020.05.2.pkl --approach tfidf-svm
    deps:
    - path: data/processed/science_grants_tagged_title_synopsis.jsonl
      md5: 2fb37d57daeece50a0190e16e229647a
      size: 2809039
    - path: grants_tagger/train.py
      md5: 162e8650a0a7e970420f48eb5c253f82
      size: 3970
    params:
      params.yaml:
        train.class_weight: balanced
        train.min_df: 5
        train.ngram_range:
        - 1
        - 2
    outs:
    - path: models/label_binarizer.pkl
      md5: 220319a004a60bd6475e2fb617c2c1f3
      size: 1067
    - path: models/tfidf-svm-2020.05.2.pkl
      md5: eceaf3846999e47380ca670c096b810a
      size: 17768856
  train_tfidf_svm:
    cmd: grants_tagger train data/processed/science_grants_tagged_title_synopsis.jsonl
      models/label_binarizer-2020.05.2.pkl models/tfidf-svm-2020.05.2.pkl --approach
      tfidf-svm --train-info results/tfidf_svm_train_info.json
    deps:
    - path: data/processed/science_grants_tagged_title_synopsis.jsonl
      md5: 2fb37d57daeece50a0190e16e229647a
      size: 2809039
    - path: grants_tagger/train.py
      md5: 13b0a13ceb6c2af5039e39754264489f
      size: 3929
    params:
      params.yaml:
        train.tfidf-svm.svm__estimator.class_weight: balanced
        train.tfidf-svm.tfidf.min_df: 5
        train.tfidf-svm.tfidf.ngram_range:
        - 1
        - 2
    outs:
    - path: models/label_binarizer-2020.05.2.pkl
      md5: 220319a004a60bd6475e2fb617c2c1f3
      size: 1067
    - path: models/tfidf-svm-2020.05.2.pkl
      md5: 6bc914f74de00bcba700afe2095b7f67
      size: 17768857
    - path: results/tfidf_svm_train_info.json
      md5: 1f2e08079c90f0d60c92491eaedaf4b4
      size: 60
  evaluate:
    cmd: grants_tagger evaluate model tfidf-svm models/tfidf-svm-2020.05.2.pkl data/processed/science_grants_tagged_title_synopsis.jsonl
      models/label_binarizer.pkl
    deps:
    - path: grants_tagger/evaluate_model.py
      md5: cd583e8d10e0c889647834cab217ce2f
      size: 1872
    - path: models/label_binarizer.pkl
      md5: 220319a004a60bd6475e2fb617c2c1f3
      size: 1067
    - path: models/tfidf-svm-2020.05.2.pkl
      md5: f24b224be6a867f96400b3df2ad26ac9
      size: 17768856
    outs:
    - path: results.json
      md5: 1d0d4fb63ae1d1b911373cc558147737
      size: 89
  evaluate_tfidf_svm:
    cmd: grants_tagger evaluate model tfidf-svm models/tfidf-svm-2020.05.2.pkl data/processed/science_grants_tagged_title_synopsis.jsonl
      models/label_binarizer-2020.05.2.pkl --results-path results/tfidf_svm.json
    deps:
    - path: grants_tagger/evaluate_model.py
      md5: 280850e5a7c78506819d470a5b8ae019
      size: 2311
    - path: models/label_binarizer-2020.05.2.pkl
      md5: 220319a004a60bd6475e2fb617c2c1f3
      size: 1067
    - path: models/tfidf-svm-2020.05.2.pkl
      md5: 6bc914f74de00bcba700afe2095b7f67
      size: 17768857
    outs:
    - path: results/tfidf_svm.json
      md5: f4a61e7af633056482e7d035e75cb658
      size: 76
  train_scibert:
    cmd: grants_tagger train data/processed/science_grants_tagged_title_synopsis.jsonl
      models/label_binarizer-2020.05.5.pkl models/scibert-2020.05.5 --approach scibert
      --train-info results/scibert_train_info.json
    deps:
    - path: data/processed/science_grants_tagged_title_synopsis.jsonl
      md5: 2fb37d57daeece50a0190e16e229647a
      size: 2809039
    - path: grants_tagger/train.py
      md5: 13b0a13ceb6c2af5039e39754264489f
      size: 3929
    params:
      params.yaml:
        train.scibert.epochs: 10
        train.scibert.learning_rate: 2e-05
        train.scibert.validation_split: 0.1
    outs:
    - path: models/label_binarizer-2020.05.5.pkl
      md5: 220319a004a60bd6475e2fb617c2c1f3
      size: 1067
    - path: models/scibert-2020.05.5
      md5: 82c33a7c3656f0327b16278ca5b25063.dir
      size: 440020006
      nfiles: 2
  evaluate_scibert:
    cmd: grants_tagger evaluate model scibert models/scibert-2020.05.5 data/processed/science_grants_tagged_title_synopsis.jsonl
      models/label_binarizer-2020.05.5.pkl --results-path results/scibert.json
    deps:
    - path: grants_tagger/evaluate_model.py
      md5: 280850e5a7c78506819d470a5b8ae019
      size: 2311
    - path: models/label_binarizer-2020.05.5.pkl
      md5: 220319a004a60bd6475e2fb617c2c1f3
      size: 1067
    - path: models/scibert-2020.05.5
      md5: 82c33a7c3656f0327b16278ca5b25063.dir
      size: 440020006
      nfiles: 2
    outs:
    - path: results/scibert.json
      md5: 7e2ea3fd0ca48b7e7d831787a502e000
      size: 76
  preprocess_bioasq_mesh:
    cmd: grants_tagger preprocess bioasq-mesh data/raw/allMeSH_2021.json data/processed/mesh2021.jsonl
      --test-split 0.01
    deps:
    - path: data/raw/allMeSH_2021.json
      md5: e827a6b8062d1312664dcf075c12d89f
      size: 27547042745
    - path: grants_tagger/preprocess_mesh.py
      md5: bd9cc4e4101acff0bbff46770f08f40c
      size: 2764
    outs:
    - path: data/processed/test_mesh2021.jsonl
      md5: 9de03e6c3768c6918421a46fc908bb9b
      size: 247324489
    - path: data/processed/train_mesh2021.jsonl
      md5: cd452731d4d4d9a6e30c5483a9490404
      size: 24471990205
  evaluate_science_ensemble:
    cmd: grants_tagger evaluate model science-ensemble models/tfidf-svm-2020.05.2.pkl,models/scibert-2020.05.5
      data/processed/science_grants_tagged_title_synopsis.jsonl models/label_binarizer-2020.05.2.pkl
      --results-path results/science_ensemble.json
    deps:
    - path: grants_tagger/evaluate_model.py
      md5: 280850e5a7c78506819d470a5b8ae019
      size: 2311
    - path: models/label_binarizer-2020.05.2.pkl
      md5: 220319a004a60bd6475e2fb617c2c1f3
      size: 1067
    - path: models/scibert-2020.05.5
      md5: 82c33a7c3656f0327b16278ca5b25063.dir
      size: 440020006
      nfiles: 2
    - path: models/tfidf-svm-2020.05.2.pkl
      md5: 6bc914f74de00bcba700afe2095b7f67
      size: 17768857
    outs:
    - path: results/science_ensemble.json
      md5: 0fe33f09efa340fefd307de9d778cb4c
      size: 76
  train_mesh_cnn:
    cmd: grants_tagger train data/processed/disease_mesh.jsonl models/disease_mesh_label_binarizer-2021.06.0.pkl
      models/disease_mesh_cnn-2021.06.0 --approach mesh-cnn --sparse-labels
    deps:
    - path: data/processed/disease_mesh.jsonl
      md5: f4463f861869e7516caef78ff75600ac
      size: 12179582610
    - path: grants_tagger/models.py
      md5: 234124a679b6f761241c4ff7ba7b2fd7
      size: 25324
    - path: grants_tagger/train.py
      md5: 78683e5785fe5f403b4d1f58211b5dc8
      size: 3971
    params:
      params.yaml:
        train.mesh-cnn.cnn.attention: true
        train.mesh-cnn.cnn.batch_size: 256
        train.mesh-cnn.cnn.dense_size: 10000
        train.mesh-cnn.cnn.dropout: 0.1
        train.mesh-cnn.cnn.hidden_size: 400
        train.mesh-cnn.cnn.l2: 7e-07
        train.mesh-cnn.cnn.learning_rate: 0.0001
        train.mesh-cnn.cnn.learning_rate_decay: 0.8
        train.mesh-cnn.cnn.multilabel: true
        train.mesh-cnn.cnn.nb_epochs: 10
        train.mesh-cnn.vec.sequence_length: 400
        train.mesh-cnn.vec.tokenizer_library: transformers
        train.mesh-cnn.vec.vocab_size: 30000
    outs:
    - path: models/disease_mesh_cnn-2021.06.0
      md5: 08ec776180c1d45ff0f35024833f843d.dir
      size: 808278043
      nfiles: 5
    - path: models/disease_mesh_label_binarizer-2021.06.0.pkl
      md5: 85be50a39457aa83f1dd4fbb2b1f26b6
      size: 147371
  filter_mesh_tags:
    cmd: python grants_tagger/filter_mesh_tags.py data/raw/desc2021.xml data/processed/mesh_disease_tags.csv
    deps:
    - path: data/raw/desc2021.xml
      md5: 8663a7dd8e1895dd22525d42b80cd2df
      size: 300410104
    outs:
    - path: data/processed/mesh_disease_tags.csv
      md5: 4311b12fb4f381ffab1d76f55069683d
      size: 260080
  train_mesh_xlinear:
    cmd: grants_tagger train data/processed/train_mesh2021.jsonl models/xlinear/label_binarizer-2021.09.0.pkl
      models/xlinear/model-2021.09.0 --approach mesh-xlinear --sparse-labels --train-info
      results/mesh_xlinear_train_info.json
    deps:
    - path: data/processed/test_mesh2021.jsonl
      md5: 9de03e6c3768c6918421a46fc908bb9b
      size: 247324489
    - path: grants_tagger/models/mesh_xlinear.py
      md5: b9f2e3c302c9826b5378fd871375fce9
      size: 3135
    - path: grants_tagger/train.py
      md5: 13b0a13ceb6c2af5039e39754264489f
      size: 3929
    params:
      params.yaml:
        train.mesh-xlinear.tfidf.lowercase: true
        train.mesh-xlinear.tfidf.max_df: 1.0
        train.mesh-xlinear.tfidf.max_features: 400000
        train.mesh-xlinear.tfidf.min_df: 5
        train.mesh-xlinear.tfidf.ngram_range:
        - 1
        - 1
        train.mesh-xlinear.tfidf.stop_words: english
        train.mesh-xlinear.xlinear.beam_size: 10
        train.mesh-xlinear.xlinear.cluster_chain: true
        train.mesh-xlinear.xlinear.min_weight_value: 0.1
        train.mesh-xlinear.xlinear.negative_sampling_scheme: tfn
        train.mesh-xlinear.xlinear.only_topk: 20
    outs:
    - path: models/xlinear/label_binarizer-2021.09.0.pkl
      md5: 67d759ed4142feab2e575dc9bd3d5f54
      size: 827793
    - path: models/xlinear/model-2021.09.0
      md5: 2d11f0f270ee04d60c9ec32d10dee21a.dir
      size: 3748753496
      nfiles: 33
  evaluate_mesh_xlinear_on_grants:
    cmd: grants_tagger evaluate model mesh-xlinear models/xlinear/model-2021.09.0
      data/raw/disease_tags_validation_grants.xlsx models/xlinear/label_binarizer-2021.09.0.pkl
      --results-path results/mesh_xlinear_on_grants.json --grants --mesh-tags-path
      data/processed/mesh_disease_tags.csv
    deps:
    - path: data/processed/mesh_disease_tags.csv
      md5: 4311b12fb4f381ffab1d76f55069683d
      size: 260080
    - path: data/raw/disease_tags_validation_grants.xlsx
      md5: 71554cf90758773fb996351000384d4f
      size: 615751
    - path: grants_tagger/evaluate_mesh_on_grants.py
      md5: 97df9a4973944ea94cfb4dd36de05d21
      size: 2716
    - path: models/xlinear/label_binarizer-2021.09.0.pkl
      md5: 67d759ed4142feab2e575dc9bd3d5f54
      size: 827793
    - path: models/xlinear/model-2021.09.0
      md5: 2d11f0f270ee04d60c9ec32d10dee21a.dir
      size: 3748753496
      nfiles: 33
    outs:
    - path: results/mesh_xlinear_on_grants.json
      md5: f056e0db544f576ed453cc1366f26f5a
      size: 26
  evaluate_mesh_xlinear:
    cmd: grants_tagger evaluate model mesh-xlinear models/xlinear/model-2021.09.0
      data/processed/test_mesh2021.jsonl models/xlinear/label_binarizer-2021.09.0.pkl
      --results-path results/mesh_xlinear.json --no-split-data
    deps:
    - path: grants_tagger/evaluate_model.py
      md5: 280850e5a7c78506819d470a5b8ae019
      size: 2311
    - path: models/xlinear/label_binarizer-2021.09.0.pkl
      md5: 67d759ed4142feab2e575dc9bd3d5f54
      size: 827793
    - path: models/xlinear/model-2021.09.0
      md5: 2d11f0f270ee04d60c9ec32d10dee21a.dir
      size: 3748753496
      nfiles: 33
    outs:
    - path: results/mesh_xlinear.json
      md5: a0e6aa5fcc7b1ae79e588ce2b38c1bf3
      size: 76
